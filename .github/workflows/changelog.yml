name: Append Commit Diff Link to Markdown Files

on:
  push:
    branches:
      - changelog  # Adjust as needed

jobs:
  append-commit-diff:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out the repository using the PAT for further push operations.
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT_TOKEN }}  # Use your PAT instead of the default GITHUB_TOKEN
          fetch-depth: 0  # Ensures full commit history for diff operations

      # Step 2: Append commit diff link to each modified Markdown file
      - name: Append commit diff link to modified Markdown files
        run: |
          COMMIT_SHA="${GITHUB_SHA}"
          echo "Processing commit: ${COMMIT_SHA}"
          
          # List files modified in this commit that end with .md
          MD_FILES=$(git diff-tree --no-commit-id --name-only -r ${COMMIT_SHA} | grep -E '\.md$' || true)
          echo "Modified Markdown files: ${MD_FILES}"
          
          # Exit if no Markdown files were modified.
          if [ -z "$MD_FILES" ]; then
            echo "No Markdown files modified. Exiting."
            exit 0
          fi
          
          # Construct the commit diff link
          COMMIT_DIFF_LINK="https://github.com/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}"
          echo "Commit diff link: ${COMMIT_DIFF_LINK}"
          
          # Append the commit diff link to each Markdown file.
          for file in $MD_FILES; do
            echo "" >> "$file"
            echo "## Commit Diff" >> "$file"
            echo "[View commit diff on GitHub](${COMMIT_DIFF_LINK})" >> "$file"
            echo "Appended commit diff link to $file"
          done

      # Step 3: Commit and push changes using the PAT
      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Append commit diff link to modified Markdown files" || echo "No changes to commit."
          git push origin HEAD:${{ github.ref }}
